
1.
CREATE PROCEDURE GetItemDetailsWithSerial
AS
BEGIN
    SELECT ROW_NUMBER() OVER (ORDER BY id.category_name) AS SERIAL,
           (id.item_name + '-' + id.UPS_code) AS item_name,
           id.item_id,
           id.category_name
    FROM item_details AS id
    INNER JOIN Stock_Entry AS se ON id.item_id = se.Item_Id
    WHERE se.Quantity != 0 AND se.Is_Status = 1
    GROUP BY id.item_name, id.item_id, id.category_name, id.UPS_code
    ORDER BY category_name ASC;
END;
EXEC GetItemDetailsWithSerial;



2.Opening Quantity:
CREATE PROCEDURE GetTotalQuantityForItem
    @ItemId INT,
    @FromDate NVARCHAR(10)
AS
BEGIN
    SELECT 
        (SELECT ISNULL(SUM(Quantity), 0) AS qty 
         FROM Stock_Entry 
         WHERE Is_Status = 1 
           AND Item_Id = @ItemId
           AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)) +
        (SELECT ISNULL(SUM(Quantity), 0) 
         FROM Store_Transfer 
         WHERE Status = 1 
           AND StockType = 'Receive' 
           AND Item_Id = @ItemId 
           AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103)) -
        ((SELECT ISNULL(SUM(Quantity), 0) 
          FROM Store_Transfer 
          WHERE Status = 1 
            AND StockType = 'Transfer' 
            AND Item_Id = @ItemId 
            AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103)) +
         (SELECT ISNULL(SUM(Quantity), 0) 
          FROM Bill_Details 
          WHERE CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
            AND Delete_Status IS NULL 
            AND itemid = @ItemId) +
         (SELECT ISNULL(SUM(Wastage), 0) 
          FROM Wastage_Details 
          WHERE CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
            AND Item_Id = @ItemId) -
         (SELECT ISNULL(SUM(Quantity), 0) 
          FROM CREDIT_NOTEBOOK_ITEM_DETAILS 
          WHERE Item_Id = @ItemId 
            AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)) +
         (SELECT ISNULL(SUM(Quantity), 0) 
          FROM DEBIT_NOTEBOOK_ITEM_DETAILS 
          WHERE Item_Id = @ItemId 
            AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103))) AS OpeningQuantity;
END;
EXEC GetTotalQuantityForItem @ItemId = 5760, @FromDate = '2023-01-01';


3. for stockIn:
===============
CREATE PROCEDURE GetStockQuantity
    @ItemId INT,
    @FromDate DATETIME,
    @ToDate DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TotalQuantity INT;

    SELECT @TotalQuantity = ISNULL(SUM(Quantity), 0)
    FROM Stock_Entry
    WHERE Is_Status = 1
        AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId;

    SELECT @TotalQuantity = @TotalQuantity + ISNULL(SUM(Quantity), 0)
    FROM Store_Transfer
    WHERE Item_Id = @ItemId
        AND StockType = 'Receive'
        AND Status = 1
        AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    SELECT @TotalQuantity AS Inqty;
END

DECLARE @ItemId INT = 5760; -- replace 123 with the actual ItemId value --
DECLARE @FromDate DATETIME = '2023-01-01'; -- replace '2023-01-01' with the actual FromDate value --
DECLARE @ToDate DATETIME = '2023-01-31'; -- replace '2023-01-31' with the actual ToDate value --

EXEC GetStockQuantity 
    @ItemId = @ItemId,
    @FromDate = @FromDate,
    @ToDate = @ToDate;

4.For stock out:
================
CREATE PROCEDURE GetBillOutQuantity
    @ItemId INT,
    @FromDate DATETIME,
    @ToDate DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TotalQuantity INT;

    SELECT @TotalQuantity = ISNULL(SUM(quantity), 0)
    FROM Bill_Details
    WHERE CONVERT(DATETIME, date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Delete_Status IS NULL
        AND itemid = @ItemId;

    SELECT @TotalQuantity = @TotalQuantity + ISNULL(SUM(Quantity), 0)
    FROM Store_Transfer
    WHERE Item_Id = @ItemId
        AND StockType = 'Transfer'
        AND Status = 1
        AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    SELECT @TotalQuantity = @TotalQuantity - ISNULL(SUM(Quantity), 0)
    FROM CREDIT_NOTEBOOK_ITEM_DETAILS
    WHERE Item_Id = @ItemId
        AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    SELECT @TotalQuantity AS qty;
END


DECLARE @ItemId INT = 5760; -- replace 123 with the actual ItemId value --
DECLARE @FromDate DATETIME = '2022-01-01'; -- replace '2023-01-01' with the actual FromDate value --
DECLARE @ToDate DATETIME = '2023-01-31'; -- replace '2023-01-31' with the actual ToDate value --

EXEC GetBillOutQuantity
    @ItemId = @ItemId,
    @FromDate = @FromDate,
    @ToDate = @ToDate;


5.return and damage:
===================
CREATE PROCEDURE GetWastageQuantity
    @ItemId INT,
    @FromDate DATETIME,
    @ToDate DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ReturnQty INT;
    DECLARE @DamageQty INT;
   
    SELECT @ReturnQty = ISNULL(SUM(Wastage), 0)
    FROM Wastage_Details
    WHERE CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId
        AND Wastage_Type = 'Return';

    SELECT @DamageQty = ISNULL(SUM(Wastage), 0)
    FROM Wastage_Details
    WHERE CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId
        AND Wastage_Type = 'Damage';

    SELECT @ReturnQty AS ReturnQty, @DamageQty AS DamageQty;
END
DECLARE @ItemId INT = 5760; -- replace 123 with the actual ItemId value --
DECLARE @FromDate DATETIME = '2022-01-01'; -- replace '2023-01-01' with the actual FromDate value --
DECLARE @ToDate DATETIME = '2023-01-31'; -- replace '2023-01-31' with the actual ToDate value --

EXEC GetWastageQuantity
    @ItemId = @ItemId,
    @FromDate = @FromDate,
    @ToDate = @ToDate;























first four column:
=================
select id.item_id as id ,id.category_name as Item_Category,
(id.item_name+'-'+id.UPS_code) as Item_name,SUM(se.Quantity) AS In_quantity
from Stock_Entry as se inner join item_details as id on se.Item_Id = id.Item_Id
where se.Quantity!=0 and se.Is_Status=1 GROUP BY
    id.item_id, id.category_name, id.item_name, id.UPS_code;

in,out:
========
select id.item_id as id ,id.category_name as Item_Category,
(id.item_name+'-'+id.UPS_code) as Item_name,SUM(se.Quantity) AS In_quantity, SUM(bd.quantity) AS Out_quantity
from Stock_Entry as se
inner join
item_details as id on se.Item_Id = id.Item_Id
left join
    Bill_Details AS bd ON se.Item_Id = bd.itemid
where
convert (datetime,se.date,103)= convert (datetime,se.Date,103) and convert(datetime,se.date,103)= convert(datetime,se.Date,103) 
and se.Quantity!=0 and se.Is_Status=1 GROUP BY
    id.item_id, id.category_nam
last sql syntax:
================
select id.item_id as id ,id.category_name as Item_Category,
(id.item_name+'-'+id.UPS_code) as Item_name,SUM(se.Quantity) AS In_quantity,
SUM(bd.quantity) AS Out_quantity,
  SUM(CASE WHEN wd.Wastage_Type = 'Return' THEN wd.Wastage ELSE 0 END) AS Return_quantity,
    SUM(CASE WHEN wd.Wastage_Type = 'Wastage' THEN wd.Wastage ELSE 0 END) AS Wastage_quantity


from Stock_Entry as se
inner join
item_details as id on se.Item_Id = id.Item_Id
left join
    Bill_Details AS bd ON se.Item_Id = bd.itemid
left join
   Wastage_Details AS wd ON se.Item_Id = wd.Item_Id
where
convert (datetime,se.date,103)= convert (datetime,se.Date,103) and convert(datetime,se.date,103)= convert(datetime,se.Date,103) 
and se.Quantity!=0 and se.Is_Status=1 GROUP BY
    id.item_id, id.category_name, id.item_name, id.UPS_code; 



===================================================================================================================================
CREATE PROCEDURE GetItemDetailsWithQuantity
    @ItemId INT,
    @FromDate DATETIME,
    @ToDate DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @OpeningQuantity INT;
    DECLARE @ClosingQuantity INT;

    -- Opening Quantity Calculation
    SELECT @OpeningQuantity = (
            (SELECT ISNULL(SUM(Quantity), 0) AS qty 
             FROM Stock_Entry 
             WHERE Is_Status = 1 
               AND Item_Id = @ItemId
               AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)) +
            (SELECT ISNULL(SUM(Quantity), 0) 
             FROM Store_Transfer 
             WHERE Status = 1 
               AND StockType = 'Receive' 
               AND Item_Id = @ItemId 
               AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103)) -
            ((SELECT ISNULL(SUM(Quantity), 0) 
              FROM Store_Transfer 
              WHERE Status = 1 
                AND StockType = 'Transfer' 
                AND Item_Id = @ItemId 
                AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103)) +
             (SELECT ISNULL(SUM(Quantity), 0) 
              FROM Bill_Details 
              WHERE CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
                AND Delete_Status IS NULL 
                AND itemid = @ItemId) +
             (SELECT ISNULL(SUM(Wastage), 0) 
              FROM Wastage_Details 
              WHERE CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
                AND Item_Id = @ItemId) -
             (SELECT ISNULL(SUM(Quantity), 0) 
              FROM CREDIT_NOTEBOOK_ITEM_DETAILS 
              WHERE Item_Id = @ItemId 
                AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)) +
             (SELECT ISNULL(SUM(Quantity), 0) 
              FROM DEBIT_NOTEBOOK_ITEM_DETAILS 
              WHERE Item_Id = @ItemId 
                AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)))
    );

    -- Stock In Quantity Calculation
    DECLARE @StockInQuantity INT;
    SELECT @StockInQuantity = ISNULL(SUM(Quantity), 0)
    FROM Stock_Entry
    WHERE Is_Status = 1
        AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId;

    SELECT @StockInQuantity = @StockInQuantity + ISNULL(SUM(Quantity), 0)
    FROM Store_Transfer
    WHERE Item_Id = @ItemId
        AND StockType = 'Receive'
        AND Status = 1
        AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    -- Stock Out Quantity Calculation
    DECLARE @StockOutQuantity INT;
    SELECT @StockOutQuantity = ISNULL(SUM(quantity), 0)
    FROM Bill_Details
    WHERE CONVERT(DATETIME, date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Delete_Status IS NULL
        AND itemid = @ItemId;

    SELECT @StockOutQuantity = @StockOutQuantity + ISNULL(SUM(Quantity), 0)
    FROM Store_Transfer
    WHERE Item_Id = @ItemId
        AND StockType = 'Transfer'
        AND Status = 1
        AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    SELECT @StockOutQuantity = @StockOutQuantity - ISNULL(SUM(Quantity), 0)
    FROM CREDIT_NOTEBOOK_ITEM_DETAILS
    WHERE Item_Id = @ItemId
        AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    -- Wastage Quantity Calculation
    DECLARE @ReturnQty INT;
    DECLARE @DamageQty INT;
   
    SELECT @ReturnQty = ISNULL(SUM(Wastage), 0)
    FROM Wastage_Details
    WHERE CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId
        AND Wastage_Type = 'Return';

    SELECT @DamageQty = ISNULL(SUM(Wastage), 0)
    FROM Wastage_Details
    WHERE CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId
        AND Wastage_Type = 'Damage';

    -- Closing Quantity Calculation
    SET @ClosingQuantity = @OpeningQuantity + @StockInQuantity - @StockOutQuantity - @ReturnQty - @DamageQty;

    -- Output Results
    SELECT 
        @OpeningQuantity AS OpeningQuantity,
        @StockInQuantity AS StockInQuantity,
        @StockOutQuantity AS StockOutQuantity,
        @ReturnQty AS ReturnQuantity,
        @DamageQty AS DamageQuantity,
        @ClosingQuantity AS ClosingQuantity;
END

-- Example Usage
DECLARE @ItemId INT = 5760;
DECLARE @FromDate DATETIME = '2022-01-01';
DECLARE @ToDate DATETIME = '2023-01-31';

EXEC GetItemDetailsWithQuantity
    @ItemId = @ItemId,
    @FromDate = @FromDate,
    @ToDate = @ToDate;



=====================================================================final==================================================
CREATE PROCEDURE GetItemDetailsWithQuantity
    @ItemId INT,
    @FromDate DATETIME,
    @ToDate DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @OpeningQuantity INT;
    DECLARE @ClosingQuantity INT;

    -- Opening Quantity Calculation
    SELECT @OpeningQuantity = (
            (SELECT ISNULL(SUM(Quantity), 0) AS qty 
             FROM Stock_Entry 
             WHERE Is_Status = 1 
               AND Item_Id = @ItemId
               AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)) +
            (SELECT ISNULL(SUM(Quantity), 0) 
             FROM Store_Transfer 
             WHERE Status = 1 
               AND StockType = 'Receive' 
               AND Item_Id = @ItemId 
               AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103)) -
            ((SELECT ISNULL(SUM(Quantity), 0) 
              FROM Store_Transfer 
              WHERE Status = 1 
                AND StockType = 'Transfer' 
                AND Item_Id = @ItemId 
                AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103)) +
             (SELECT ISNULL(SUM(Quantity), 0) 
              FROM Bill_Details 
              WHERE CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
                AND Delete_Status IS NULL 
                AND itemid = @ItemId) +
             (SELECT ISNULL(SUM(Wastage), 0) 
              FROM Wastage_Details 
              WHERE CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
                AND Item_Id = @ItemId) -
             (SELECT ISNULL(SUM(Quantity), 0) 
              FROM CREDIT_NOTEBOOK_ITEM_DETAILS 
              WHERE Item_Id = @ItemId 
                AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)) +
             (SELECT ISNULL(SUM(Quantity), 0) 
              FROM DEBIT_NOTEBOOK_ITEM_DETAILS 
              WHERE Item_Id = @ItemId 
                AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)))
    );

    -- Stock In Quantity Calculation
    DECLARE @StockInQuantity INT;
    SELECT @StockInQuantity = ISNULL(SUM(Quantity), 0)
    FROM Stock_Entry
    WHERE Is_Status = 1
        AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId;

    SELECT @StockInQuantity = @StockInQuantity + ISNULL(SUM(Quantity), 0)
    FROM Store_Transfer
    WHERE Item_Id = @ItemId
        AND StockType = 'Receive'
        AND Status = 1
        AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    -- Stock Out Quantity Calculation
    DECLARE @StockOutQuantity INT;
    SELECT @StockOutQuantity = ISNULL(SUM(quantity), 0)
    FROM Bill_Details
    WHERE CONVERT(DATETIME, date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Delete_Status IS NULL
        AND itemid = @ItemId;

    SELECT @StockOutQuantity = @StockOutQuantity + ISNULL(SUM(Quantity), 0)
    FROM Store_Transfer
    WHERE Item_Id = @ItemId
        AND StockType = 'Transfer'
        AND Status = 1
        AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    SELECT @StockOutQuantity = @StockOutQuantity - ISNULL(SUM(Quantity), 0)
    FROM CREDIT_NOTEBOOK_ITEM_DETAILS
    WHERE Item_Id = @ItemId
        AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103);

    -- Wastage Quantity Calculation
    DECLARE @ReturnQty INT;
    DECLARE @DamageQty INT;
   
    SELECT @ReturnQty = ISNULL(SUM(Wastage), 0)
    FROM Wastage_Details
    WHERE CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId
        AND Wastage_Type = 'Return';

    SELECT @DamageQty = ISNULL(SUM(Wastage), 0)
    FROM Wastage_Details
    WHERE CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        AND Item_Id = @ItemId
        AND Wastage_Type = 'Damage';

    -- Closing Quantity Calculation
    SET @ClosingQuantity = @OpeningQuantity + @StockInQuantity - @StockOutQuantity - @ReturnQty - @DamageQty;

    -- Output Results
   SELECT 
        ROW_NUMBER() OVER (ORDER BY id.category_name) AS SERIAL,
        (id.item_name + '-' + id.UPS_code) AS item_name,
        id.item_id,
        id.category_name,
        @OpeningQuantity AS OpeningQuantity,
        @StockInQuantity AS StockInQuantity,
        @StockOutQuantity AS StockOutQuantity,
        @ReturnQty AS ReturnQuantity,
        @DamageQty AS DamageQuantity,
        @ClosingQuantity AS ClosingQuantity
    FROM item_details AS id
    INNER JOIN Stock_Entry AS se ON id.item_id = se.Item_Id
    WHERE se.Quantity != 0 AND se.Is_Status = 1 and se.Item_Id=@ItemId
    GROUP BY id.item_name, id.item_id, id.category_name, id.UPS_code
    ORDER BY category_name ASC;
END
DECLARE @ItemId INT = 5759;
DECLARE @FromDate DATETIME = '2022-01-01';
DECLARE @ToDate DATETIME = '2023-01-31';

EXEC GetItemDetailsWithQuantity
    @ItemId = @ItemId,
    @FromDate = @FromDate,
    @ToDate = @ToDate;

=====
SELECT Item_Id, SUM(Quantity) AS TotalQuantity
FROM Stock_Entry
WHERE Is_Status = 1 
    AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, '01-01-2020', 103) AND CONVERT(DATETIME, '15-11-2023', 103)
GROUP BY Item_Id;


=======================

SELECT 
    Item_Id,
    SUM(Quantity) AS TotalQuantity
FROM Stock_Entry
WHERE Is_Status = 1 
    AND (
        (@ItemId IS NULL) OR
        (Item_Id = @ItemId)
    )
    AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, '04-02-2020', 103) AND CONVERT(DATETIME, '07-11-2023', 103)
GROUP BY Item_Id;





























Normal Query
=============



opening Quantity
=================
DECLARE @ItemId INT = 5760;
DECLARE @FromDate DATETIME = '2023-11-16';

WITH OpeningStock AS 
    (
     SELECT Item_Id, SUM(Quantity) AS OpeningQuantity FROM  Stock_Entry WHERE Is_Status = 1 AND ((@ItemId IS NULL) OR (Item_Id = @ItemId))
     AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)  GROUP BY Item_Id
    ),
ReceivedStock AS
   (
    SELECT Item_Id, SUM(Quantity) AS OpeningQuantity FROM Store_Transfer WHERE Status = 1 AND StockType = 'Receive'
	AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103) GROUP BY Item_Id
   ),
TransferredStock AS
   (
    SELECT Item_Id,SUM(Quantity) AS OpeningQuantity FROM Store_Transfer WHERE Status = 1 AND StockType = 'Transfer'
	AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103) GROUP BY Item_Id
   ),
BillStock AS
   (
    SELECT itemid AS Item_Id, SUM(Quantity) AS OpeningQuantity FROM Bill_Details WHERE 
    CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) AND Delete_Status IS NULL AND ((@ItemId IS NULL) OR (itemid = @ItemId)) GROUP BY itemid
   ),
WastageStock AS
   (
    SELECT Item_Id, SUM(Wastage) AS OpeningQuantity FROM Wastage_Details WHERE 
    CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) GROUP BY Item_Id
   ),
CreditNoteStock AS 
   (
    SELECT Item_Id, SUM(Quantity) AS OpeningQuantity FROM CREDIT_NOTEBOOK_ITEM_DETAILS WHERE 
    ((@ItemId IS NULL) OR (Item_Id = @ItemId)) AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) GROUP BY Item_Id
   ),
DebitNoteStock AS 
   (
    SELECT  Item_Id,SUM(Quantity) AS OpeningQuantity FROM DEBIT_NOTEBOOK_ITEM_DETAILS WHERE 
    ((@ItemId IS NULL) OR (Item_Id = @ItemId)) AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) GROUP BY  Item_Id
   )
SELECT 
    COALESCE(OpeningStock.Item_Id, ReceivedStock.Item_Id, TransferredStock.Item_Id, BillStock.Item_Id, WastageStock.Item_Id, CreditNoteStock.Item_Id, DebitNoteStock.Item_Id) AS Item_Id,
    COALESCE(OpeningStock.OpeningQuantity, 0) + COALESCE(ReceivedStock.OpeningQuantity, 0) 
    - (COALESCE(TransferredStock.OpeningQuantity, 0) + COALESCE(BillStock.OpeningQuantity, 0) + COALESCE(WastageStock.OpeningQuantity, 0) 
    - COALESCE(CreditNoteStock.OpeningQuantity, 0) + COALESCE(DebitNoteStock.OpeningQuantity, 0)) AS Result
FROM  OpeningStock
        FULL OUTER JOIN ReceivedStock ON OpeningStock.Item_Id = ReceivedStock.Item_Id
        FULL OUTER JOIN TransferredStock ON OpeningStock.Item_Id = TransferredStock.Item_Id
        FULL OUTER JOIN BillStock ON OpeningStock.Item_Id = BillStock.Item_Id
        FULL OUTER JOIN WastageStock ON OpeningStock.Item_Id = WastageStock.Item_Id
        FULL OUTER JOIN CreditNoteStock ON OpeningStock.Item_Id = CreditNoteStock.Item_Id
        FULL OUTER JOIN  DebitNoteStock ON OpeningStock.Item_Id = DebitNoteStock.Item_Id;


stock in
=============================================
DECLARE @ItemId INT = null;
DECLARE @FromDate DATETIME = '2020-02-04'; 
DECLARE @ToDate DATETIME = '2023-11-16'; 

-- Combine the results
 Select Sum(TotalQuantity) as InQuantity ,Item_Id from
(
-- Calculate the sum of quantity for stock_entry
select Sum(T1.TotalQuantity) TotalQuantity,T1.Item_Id from
    (SELECT  Item_Id, SUM(Quantity) AS TotalQuantity FROM Stock_Entry WHERE Is_Status = 1 
    AND ( (@ItemId IS NULL) OR (Item_Id = @ItemId))
    AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
    GROUP BY Item_Id) T1  GROUP BY T1.Item_Id
	UNION  All
	-- Calculate the sum of quantity for Store_Transfer
select Sum(T2.TotalQuantity) TotalQuantity,T2.Item_Id from
    (SELECT  Item_Id, SUM(Quantity) AS TotalQuantity  FROM Store_Transfer WHERE StockType = 'Receive'
    AND Status = 1 AND ( (@ItemId IS NULL) OR (Item_Id = @ItemId))
    AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME,@FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
    GROUP BY Item_Id)T2  GROUP BY T2.Item_Id
) T3 group by T3.Item_Id  ;



stock out
================================================
DECLARE @ItemId INT = 5760;
DECLARE @FromDate DATETIME = '2020-02-04'; 
DECLARE @ToDate DATETIME = '2023-11-16'; 

-- Calculate the sum of quantity for Bill_Details
WITH BillDetailsSum AS (
    SELECT  COALESCE(SUM(quantity), 0) AS TotalQuantity,itemid FROM  Bill_Details WHERE
    CONVERT(DATETIME, date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
    AND Delete_Status IS NULL AND ((@ItemId IS NULL) OR (itemid = @ItemId)) GROUP BY itemid)
-- Calculate the sum of quantity for Store_Transfer
, StoreTransferSum AS (
    SELECT COALESCE(SUM(Quantity), 0) AS TotalQuantity,Item_Id FROM Store_Transfer WHERE
    ((@ItemId IS NULL) OR (Item_Id = @ItemId)) AND StockType = 'Transfer' AND Status = 1
    AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
    GROUP BY Item_Id )
-- Calculate the sum of quantity for CREDIT_NOTEBOOK_ITEM_DETAILS
, CreditNotebookSum AS (
    SELECT COALESCE(SUM(Quantity), 0) AS TotalQuantity,Item_Id FROM CREDIT_NOTEBOOK_ITEM_DETAILS WHERE
    CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
    AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) GROUP BY Item_Id)
-- Combine and subtract the results
SELECT
    COALESCE(B.TotalQuantity, 0) + COALESCE(ST.TotalQuantity, 0) - COALESCE(CN.TotalQuantity, 0) AS TotalQuantity,
    COALESCE(B.itemid, ST.Item_Id, CN.Item_Id) AS Item_Id
FROM BillDetailsSum B
FULL OUTER JOIN StoreTransferSum ST ON B.itemid = ST.Item_Id
FULL OUTER JOIN CreditNotebookSum CN ON COALESCE(B.itemid, ST.Item_Id) = CN.Item_Id;

return 
=================
  DECLARE @ItemId INT = null;
DECLARE @FromDate DATETIME = '2020-02-04'; 
DECLARE @ToDate DATETIME = '2023-11-16'; 
  
    SELECT SUM(Wastage) as returntype ,Item_Id
    FROM Wastage_Details WHERE CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
    AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) AND Wastage_Type = 'Return' group by Item_Id;

 damage
==========
	 DECLARE @ItemId INT = null;
DECLARE @FromDate DATETIME = '2020-02-04'; 
DECLARE @ToDate DATETIME = '2023-11-16'; 
  
    SELECT SUM(Wastage) damagetype,Item_Id
	FROM Wastage_Details WHERE CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
    AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) AND Wastage_Type = 'Damage' group by Item_Id;









	     
================procedure Queruy ===================
====================================================

for opening
==========
CREATE PROCEDURE CalculateStockResult
    @ItemId INT,
    @FromDate DATETIME
AS
BEGIN
    WITH OpeningStock AS 
    (
        SELECT Item_Id, SUM(Quantity) AS OpeningQuantity 
        FROM Stock_Entry 
        WHERE Is_Status = 1 AND ((@ItemId IS NULL) OR (Item_Id = @ItemId))
        AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103)  
        GROUP BY Item_Id
    ),
    ReceivedStock AS
    (
        SELECT Item_Id, SUM(Quantity) AS OpeningQuantity 
        FROM Store_Transfer 
        WHERE Status = 1 AND StockType = 'Receive'
        AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) 
        AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103) 
        GROUP BY Item_Id
    ),
    TransferredStock AS
    (
        SELECT Item_Id, SUM(Quantity) AS OpeningQuantity 
        FROM Store_Transfer 
        WHERE Status = 1 AND StockType = 'Transfer'
        AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) 
        AND CONVERT(DATETIME, Date_Tr, 103) < CONVERT(DATETIME, @FromDate, 103) 
        GROUP BY Item_Id
    ),
    BillStock AS
    (
        SELECT itemid AS Item_Id, SUM(Quantity) AS OpeningQuantity 
        FROM Bill_Details 
        WHERE CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
        AND Delete_Status IS NULL AND ((@ItemId IS NULL) OR (itemid = @ItemId)) 
        GROUP BY itemid
    ),
    WastageStock AS
    (
        SELECT Item_Id, SUM(Wastage) AS OpeningQuantity 
        FROM Wastage_Details 
        WHERE CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
        AND ((@ItemId IS NULL) OR (Item_Id = @ItemId)) 
        GROUP BY Item_Id
    ),
    CreditNoteStock AS 
    (
        SELECT Item_Id, SUM(Quantity) AS OpeningQuantity 
        FROM CREDIT_NOTEBOOK_ITEM_DETAILS 
        WHERE ((@ItemId IS NULL) OR (Item_Id = @ItemId)) 
        AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
        GROUP BY Item_Id
    ),
    DebitNoteStock AS 
    (
        SELECT Item_Id, SUM(Quantity) AS OpeningQuantity 
        FROM DEBIT_NOTEBOOK_ITEM_DETAILS 
        WHERE ((@ItemId IS NULL) OR (Item_Id = @ItemId)) 
        AND CONVERT(DATETIME, Date, 103) < CONVERT(DATETIME, @FromDate, 103) 
        GROUP BY Item_Id
    )
    SELECT 
        COALESCE(OpeningStock.Item_Id, ReceivedStock.Item_Id, TransferredStock.Item_Id, BillStock.Item_Id, WastageStock.Item_Id, CreditNoteStock.Item_Id, DebitNoteStock.Item_Id) AS Item_Id,
        COALESCE(OpeningStock.OpeningQuantity, 0) + COALESCE(ReceivedStock.OpeningQuantity, 0) 
        - (COALESCE(TransferredStock.OpeningQuantity, 0) + COALESCE(BillStock.OpeningQuantity, 0) + COALESCE(WastageStock.OpeningQuantity, 0) 
        - COALESCE(CreditNoteStock.OpeningQuantity, 0) + COALESCE(DebitNoteStock.OpeningQuantity, 0)) AS Result
    FROM  OpeningStock
        FULL OUTER JOIN ReceivedStock ON OpeningStock.Item_Id = ReceivedStock.Item_Id
        FULL OUTER JOIN TransferredStock ON OpeningStock.Item_Id = TransferredStock.Item_Id
        FULL OUTER JOIN BillStock ON OpeningStock.Item_Id = BillStock.Item_Id
        FULL OUTER JOIN WastageStock ON OpeningStock.Item_Id = WastageStock.Item_Id
        FULL OUTER JOIN CreditNoteStock ON OpeningStock.Item_Id = CreditNoteStock.Item_Id
        FULL OUTER JOIN DebitNoteStock ON OpeningStock.Item_Id = DebitNoteStock.Item_Id;
END;
EXEC CalculateStockResult @ItemId = null, @FromDate = '2023-11-16';

for stockIn
===========
CREATE PROCEDURE CalculateStockIn
    @ItemId INT = NULL,
    @FromDate DATETIME,
    @ToDate DATETIME
AS
BEGIN
    -- Combine the results
    SELECT SUM(TotalQuantity) AS InQuantity, Item_Id
    FROM
    (
        -- Calculate the sum of quantity for Stock_Entry
        SELECT SUM(T1.TotalQuantity) AS TotalQuantity, T1.Item_Id
        FROM
        (
            SELECT Item_Id, SUM(Quantity) AS TotalQuantity
            FROM Stock_Entry
            WHERE Is_Status = 1 
                AND ((@ItemId IS NULL) OR (Item_Id = @ItemId))
                AND CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
            GROUP BY Item_Id
        ) T1
        GROUP BY T1.Item_Id

        UNION ALL

        -- Calculate the sum of quantity for Store_Transfer
        SELECT SUM(T2.TotalQuantity) AS TotalQuantity, T2.Item_Id
        FROM
        (
            SELECT Item_Id, SUM(Quantity) AS TotalQuantity
            FROM Store_Transfer
            WHERE StockType = 'Receive'
                AND Status = 1 
                AND ((@ItemId IS NULL) OR (Item_Id = @ItemId))
                AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
            GROUP BY Item_Id
        ) T2
        GROUP BY T2.Item_Id
    ) T3
    GROUP BY T3.Item_Id;
END;
EXEC CalculateStockIn @ItemId = NULL, @FromDate = '2020-02-04', @ToDate = '2023-11-16';


		
stockout
-=======
CREATE PROCEDURE CalculateTotalQuantity
    @ItemId INT,
    @FromDate DATETIME,
    @ToDate DATETIME
AS
BEGIN
    -- Calculate the sum of quantity for Bill_Details
    WITH BillDetailsSum AS (
        SELECT
            COALESCE(SUM(quantity), 0) AS TotalQuantity,
            itemid
        FROM
            Bill_Details
        WHERE
            CONVERT(DATETIME, date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
            AND Delete_Status IS NULL AND ((@ItemId IS NULL) OR (itemid = @ItemId))
        GROUP BY
            itemid
    ),
    -- Calculate the sum of quantity for Store_Transfer
    StoreTransferSum AS (
        SELECT
            COALESCE(SUM(Quantity), 0) AS TotalQuantity,
            Item_Id
        FROM
            Store_Transfer
        WHERE
            ((@ItemId IS NULL) OR (Item_Id = @ItemId)) AND StockType = 'Transfer' AND Status = 1
            AND CONVERT(DATETIME, Date_Tr, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
        GROUP BY
            Item_Id
    ),
    -- Calculate the sum of quantity for CREDIT_NOTEBOOK_ITEM_DETAILS
    CreditNotebookSum AS (
        SELECT
            COALESCE(SUM(Quantity), 0) AS TotalQuantity,
            Item_Id
        FROM
            CREDIT_NOTEBOOK_ITEM_DETAILS
        WHERE
            CONVERT(DATETIME, Date, 103) BETWEEN CONVERT(DATETIME, @FromDate, 103) AND CONVERT(DATETIME, @ToDate, 103)
            AND ((@ItemId IS NULL) OR (Item_Id = @ItemId))
        GROUP BY
            Item_Id
    )
    -- Combine and subtract the results
    SELECT
        COALESCE(B.TotalQuantity, 0) + COALESCE(ST.TotalQuantity, 0) - COALESCE(CN.TotalQuantity, 0) AS TotalQuantity,
        COALESCE(B.itemid, ST.Item_Id, CN.Item_Id) AS Item_Id
    FROM
        BillDetailsSum B
    FULL OUTER JOIN
        StoreTransferSum ST ON B.itemid = ST.Item_Id
    FULL OUTER JOIN
        CreditNotebookSum CN ON COALESCE(B.itemid, ST.Item_Id) = CN.Item_Id;
END;
-- Declare variables
DECLARE @ItemId INT = 5759;
DECLARE @FromDate DATETIME = '2020-02-04';
DECLARE @ToDate DATETIME = '2023-11-16';

-- Execute the stored procedure
EXEC CalculateTotalQuantity @ItemId, @FromDate, @ToDate;






